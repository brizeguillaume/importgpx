<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ironman 70.3 Mont-Tremblant</title>
    <!-- Polices -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <!-- Icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Carte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
    <!-- Graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #e63946;
            --dark: #1d3557;
            --light: #f1faee;
            --accent: #a8dadc;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Open Sans', sans-serif;
            color: white;
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.7)), 
                        url('https://images.unsplash.com/photo-1579033462043-0f11a7862f7d?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .logo-container {
            width: 150px;
        }
        
        .logo-container img {
            width: 100%;
            height: auto;
        }
        
        .title-container {
            text-align: center;
        }
        
        h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 4rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            color: var(--primary);
        }
        
        h2 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 2.5rem;
            margin-top: 0.5rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        .countdown {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .countdown-box {
            background: rgba(29, 53, 87, 0.8);
            border-radius: 10px;
            padding: 1.5rem;
            min-width: 100px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .countdown-value {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
        }
        
        .countdown-label {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.5rem;
            opacity: 0.8;
        }
        
        .motivation {
            font-size: 1.5rem;
            font-style: italic;
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(168, 218, 220, 0.2);
            border-left: 4px solid var(--primary);
            border-radius: 0 8px 8px 0;
            animation: fadeIn 2s ease-out;
        }
        
        .dashboard {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            color: var(--dark);
        }
        
        #map {
            height: 400px;
            border-radius: 10px;
            margin-bottom: 2rem;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .upload-section {
            background: rgba(241, 250, 238, 0.9);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border: 2px dashed var(--dark);
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: var(--primary);
            background: rgba(241, 250, 238, 1);
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 1rem;
        }
        
        button:hover {
            background-color: #c1121f;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(230, 57, 70, 0.4);
        }
        
        .stats {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            h2 { font-size: 1.8rem; }
            .countdown { flex-wrap: wrap; }
            .countdown-box { min-width: 80px; padding: 1rem; }
            .countdown-value { font-size: 2rem; }
            .logo-container { width: 100px; }
            .stat-card { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-container">
                <div class="logo-container">
                    <img src="https://www.ironman.com/im703/lib/img/im-branding/ironman-70.3-logo.svg" alt="Ironman 70.3 Logo">
                </div>
                <div class="title-container">
                    <h1>Mont-Tremblant</h1>
                    <h2>25 Juin 2025</h2>
                </div>
            </div>
            
            <div class="countdown" id="countdown">
                <div class="countdown-box">
                    <div class="countdown-value" id="days">00</div>
                    <div class="countdown-label">Jours</div>
                </div>
                <div class="countdown-box">
                    <div class="countdown-value" id="hours">00</div>
                    <div class="countdown-label">Heures</div>
                </div>
                <div class="countdown-box">
                    <div class="countdown-value" id="minutes">00</div>
                    <div class="countdown-label">Minutes</div>
                </div>
                <div class="countdown-box">
                    <div class="countdown-value" id="seconds">00</div>
                    <div class="countdown-label">Secondes</div>
                </div>
            </div>
            
            <div class="motivation" id="motivation">
                "La discipline est le pont entre les objectifs et leur réalisation."
            </div>
        </header>
        
        <div class="dashboard">
            <div id="map"></div>
            
            <div class="stats">
                <div class="stat-card" id="distance">Distance: 0 km</div>
                <div class="stat-card" id="duration">Durée: 0 min</div>
                <div class="stat-card" id="elevation">Dénivelé: 0 m</div>
                <div class="stat-card" id="pace">Allure: 0 min/km</div>
            </div>
            
            <div class="upload-section">
                <h3 style="color: var(--dark); margin-top: 0;">Importer votre entraînement GPX</h3>
                <input type="file" id="gpxFileInput" accept=".gpx" style="display: none;">
                <button onclick="document.getElementById('gpxFileInput').click()">
                    <i class="fas fa-upload"></i> Sélectionner un fichier
                </button>
                <div id="fileList" style="margin-top: 1rem;"></div>
            </div>
            
            <div class="chart-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div class="chart-box">
                    <canvas id="elevationChart"></canvas>
                </div>
                <div class="chart-box">
                    <canvas id="speedChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    
    <script>
        // Variables globales
        let map;
        let currentWorkout = null;
        let elevationChart, speedChart;
        
        // Phrases de motivation
        const motivationalQuotes = [
            "La douleur est temporaire, la fierté est éternelle.",
            "Ce qui ne vous tue pas vous rend plus fort.",
            "Le succès est la somme de petits efforts répétés jour après jour.",
            "La limite existe seulement dans votre esprit.",
            "La course est à 90% mentale et 10% physique.",
            "Chaque pas vous rapproche de la ligne d'arrivée.",
            "Soyez plus fort que vos excuses.",
            "La seule mauvaise séance est celle que vous n'avez pas faite."
        ];
        
        // Initialisation
        document.addEventListener("DOMContentLoaded", function() {
            initMap();
            initCharts();
            setupEventListeners();
            updateCountdown();
            setInterval(updateCountdown, 1000);
            changeMotivation();
            setInterval(changeMotivation, 10000);
        });
        
        function initMap() {
            // Carte centrée sur Mont-Tremblant
            map = L.map('map').setView([46.2127, -74.5824], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            
            // Marqueur de la ligne d'arrivée
            const finishIcon = L.divIcon({
                className: 'finish-icon',
                html: '<i class="fas fa-flag-checkered" style="color: #e63946; font-size: 32px;"></i>',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });
            
            L.marker([46.1200, -74.6000], { icon: finishIcon })
                .addTo(map)
                .bindPopup("Ligne d'arrivée Ironman 70.3");
        }
        
        function initCharts() {
            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { display: false }
                }
            };
            
            elevationChart = new Chart(
                document.getElementById('elevationChart'),
                {
                    type: 'line',
                    options: {
                        ...chartOptions,
                        plugins: { title: { display: true, text: 'Profil d\'altitude (m)' } }
                    }
                }
            );
            
            speedChart = new Chart(
                document.getElementById('speedChart'),
                {
                    type: 'line',
                    options: {
                        ...chartOptions,
                        plugins: { title: { display: true, text: 'Vitesse (km/h)' } }
                    }
                }
            );
        }
        
        function setupEventListeners() {
            document.getElementById('gpxFileInput').addEventListener('change', handleGpxUpload);
        }
        
        // Compte à rebours
        function updateCountdown() {
            const eventDate = new Date("June 25, 2025 07:00:00").getTime();
            const now = new Date().getTime();
            const distance = eventDate - now;
            
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            document.getElementById("days").textContent = days.toString().padStart(2, "0");
            document.getElementById("hours").textContent = hours.toString().padStart(2, "0");
            document.getElementById("minutes").textContent = minutes.toString().padStart(2, "0");
            document.getElementById("seconds").textContent = seconds.toString().padStart(2, "0");
        }
        
        // Phrases de motivation
        function changeMotivation() {
            const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            document.getElementById("motivation").textContent = `"${quote}"`;
        }
        
        // Gestion des fichiers GPX
        async function handleGpxUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            const file = files[0];
            document.getElementById('fileList').innerHTML = 
                `<p><i class="fas fa-check-circle" style="color: green;"></i> ${file.name} - Analyse en cours...</p>`;
            
            try {
                currentWorkout = await parseGPXFile(file);
                updateUI(currentWorkout);
                document.getElementById('fileList').innerHTML = 
                    `<p><i class="fas fa-check-circle" style="color: green;"></i> ${file.name} - Analyse terminée</p>`;
            } catch (error) {
                document.getElementById('fileList').innerHTML = 
                    `<p><i class="fas fa-times-circle" style="color: red;"></i> ${file.name} - Erreur: ${error.message}</p>`;
                console.error("Erreur d'analyse GPX:", error);
            }
        }
        
        // Parser GPX
        async function parseGPXFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(event.target.result, "text/xml");
                        
                        // Vérifier que c'est un fichier GPX valide
                        if (!xmlDoc.querySelector('trkpt')) {
                            throw new Error("Ce n'est pas un fichier GPX valide");
                        }
                        
                        // Extraire les points de tracé
                        const trkpts = Array.from(xmlDoc.querySelectorAll('trkpt'));
                        const points = trkpts.map(pt => {
                            const lat = parseFloat(pt.getAttribute('lat'));
                            const lon = parseFloat(pt.getAttribute('lon'));
                            const ele = parseFloat(pt.querySelector('ele')?.textContent || 0);
                            const time = pt.querySelector('time')?.textContent;
                            const ext = pt.querySelector('extensions');
                            const hr = ext ? parseInt(ext.querySelector('hr')?.textContent) : null;
                            const speed = ext ? parseFloat(ext.querySelector('speed')?.textContent) * 3.6 : null; // m/s → km/h
                            
                            return { lat, lon, ele, time, hr, speed };
                        });
                        
                        // Calcul des statistiques
                        const stats = calculateStats(points);
                        
                        // Formatage des données
                        const workoutData = {
                            fileName: file.name,
                            points,
                            stats,
                            startTime: points[0]?.time,
                            endTime: points[points.length - 1]?.time,
                            type: detectActivityType(points, stats)
                        };
                        
                        resolve(workoutData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error("Erreur de lecture du fichier"));
                reader.readAsText(file);
            });
        }
        
        // Calcul des statistiques
        function calculateStats(points) {
            let distance = 0;
            let elevationGain = 0;
            let prevPoint = points[0];
            const elevations = [];
            const speeds = [];
            
            points.forEach((point, i) => {
                if (i > 0) {
                    // Calcul de la distance (en km)
                    distance += getDistanceFromLatLonInKm(
                        prevPoint.lat, prevPoint.lon,
                        point.lat, point.lon
                    );
                    
                    // Calcul du dénivelé positif (en m)
                    if (point.ele > prevPoint.ele) {
                        elevationGain += point.ele - prevPoint.ele;
                    }
                }
                
                // Stockage pour les graphiques
                elevations.push(point.ele);
                if (point.speed) speeds.push(point.speed);
                
                prevPoint = point;
            });
            
            // Calcul de la durée (en minutes)
            const duration = points.length > 1 ? 
                (new Date(points[points.length - 1].time) - new Date(points[0].time)) / 60000 : 0;
            
            // Calcul de l'allure (en min/km)
            const avgPace = distance > 0 ? duration / distance : 0;
            const paceFormatted = `${Math.floor(avgPace)}:${Math.floor((avgPace % 1) * 60).toString().padStart(2, '0')}`;
            
            return {
                distance: parseFloat(distance.toFixed(2)),
                duration: parseFloat(duration.toFixed(1)),
                elevationGain: Math.round(elevationGain),
                avgSpeed: speeds.length ? (speeds.reduce((a, b) => a + b, 0) / speeds.length : null,
                avgPace: paceFormatted,
                elevations,
                speeds
            };
        }
        
        // Détection du type d'activité
        function detectActivityType(points, stats) {
            if (points.length < 2) return "Inconnu";
            
            // Basé sur la vitesse moyenne
            if (stats.avgSpeed) {
                if (stats.avgSpeed > 25) return "Vélo";
                if (stats.avgSpeed > 10) return "Course à pied";
                return "Natation";
            }
            
            // Basé sur la distance/durée
            const avgSpeedKph = stats.distance / (stats.duration / 60);
            if (avgSpeedKph > 25) return "Vélo";
            if (avgSpeedKph > 10) return "Course à pied";
            return "Natation";
        }
        
        // Mise à jour de l'interface
        function updateUI(workout) {
            if (!workout) return;
            
            // Mise à jour des statistiques
            document.getElementById('distance').textContent = `Distance: ${workout.stats.distance} km`;
            document.getElementById('duration').textContent = `Durée: ${workout.stats.duration} min`;
            document.getElementById('elevation').textContent = `Dénivelé: ${workout.stats.elevationGain} m`;
            document.getElementById('pace').textContent = `Allure: ${workout.stats.avgPace} /km`;
            
            // Mise à jour de la carte
            updateMap(workout.points);
            
            // Mise à jour des graphiques
            updateChart(elevationChart, 'Altitude (m)', workout.stats.elevations, '#4CAF50');
            if (workout.stats.speeds.length) {
                updateChart(speedChart, 'Vitesse (km/h)', workout.stats.speeds, '#FF5722');
            }
        }
        
        // Mise à jour de la carte
        function updateMap(points) {
            // Supprimer l'ancien tracé
            map.eachLayer(layer => {
                if (layer instanceof L.Polyline) map.removeLayer(layer);
            });
            
            // Ajouter le nouveau tracé
            if (points.length > 1) {
                const latLngs = points.map(p => [p.lat, p.lon]);
                L.polyline(latLngs, {
                    color: '#E63946',
                    weight: 4,
                    opacity: 0.8,
                    lineJoin: 'round'
                }).addTo(map);
                
                // Ajuster la vue
                map.fitBounds(L.polyline(latLngs).getBounds(), { padding: [50, 50] });
            }
        }
        
        // Mise à jour des graphiques
        function updateChart(chart, label, data, color) {
            chart.data = {
                labels: data.map((_, i) => i),
                datasets: [{
                    label,
                    data,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            };
            chart.update();
        }
        
        // Calcul de distance entre 2 points GPS (formule haversine)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }
    </script>
</body>
</html>